/*! BrowserStorageAbuser - v0.1.0 - 2014-01-22
* Copyright (c) 2014 ; Licensed  */
var app=angular.module("BrowserStorageAbuser",[]);app.value("storages",[{name:"FileSystem",desc:"The File System API simulates a local file system that web apps can navigate around. You can develop apps that can read, write, and create files and directories in a virtual, sandboxed file system.",link:"https://developer.mozilla.org/docs/WebGuide/API/File_System"},{name:"IndexedDB",desc:"IndexedDB is an API for client-side storage of significant amounts of structured data and for high performance searches on this data using indexes. While DOM Storage is useful for storing smaller amounts of data, it is less useful for storing larger amounts of structured data. IndexedDB provides a solution.",link:"https://developer.mozilla.org/docs/IndexedDB"},{name:"WebSQL",desc:"Web SQL Database is a web page API for storing data in databases that can be queried using a variant of SQL. The API is supported by Google Chrome, Opera, Safari and the Android Browser. The W3C Web Applications Working Group ceased working on the specification in November 2010, citing a lack of independent implementations (i.e., the use of a database system other than SQLite as the backend) as the reason the specification could not move forward to become a W3C Recommendation. One potential alternative storage standard is IndexedDB.",link:"http://wikipedia.org/wiki/Web_SQL_Database"},{name:"LocalStorage",desc:"DOM Storage is the name given to the set of storage-related features first introduced in the Web Applications 1.0 specification, and now split off into its own W3C Web Storage specification. DOM Storage is designed to provide a larger, more secure, and easier-to-use alternative to storing information in cookies. It was first introduced with Firefox 2 and Safari 4.",link:"https://developer.mozilla.org/docs/Web/Guide/API/DOM/Storage"},{name:"SessionStorage",desc:"DOM Storage is the name given to the set of storage-related features first introduced in the Web Applications 1.0 specification, and now split off into its own W3C Web Storage specification. DOM Storage is designed to provide a larger, more secure, and easier-to-use alternative to storing information in cookies. It was first introduced with Firefox 2 and Safari 4.",link:"https://developer.mozilla.org/docs/Web/Guide/API/DOM/Storage"}]),app.factory("FileSystem",["$window",function(a){var b=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,c=function(a){var b=a.target.error;"QuotaExceededError"===b.name&&(this.filled=!0,alert(b.message)),console&&console.error(b.message),this.queue=[],this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()},d=function(){var a=this.queue.shift();this.storage.root.getFile(a.name,{create:!0,exclusive:!1},function(b){b.createWriter(function(b){b.onwriteend=function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),d.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),b.onerror=c.bind(this),a instanceof Blob?b.write(a):a.file(function(a){b.write(a)})}.bind(this))}.bind(this),c.bind(this))},e=function(){return this.supported=!1,this.storage=null,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,b?(this.open("TEMPORARY",0,function(){this.getAll()}.bind(this)),void 0):(console.info("FileSystem API not supported on this browser"),void 0)};return e.prototype={open:function(c,d,e){b(a[c],d,function(a){this.supported=!0,this.storage=a,"function"==typeof e&&e()}.bind(this),function(a){this.supported=!1,console.error(a.message),"function"==typeof e&&e()})},add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading||(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),d.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],b=0;this.loading=!0;var d=this.storage.root.createReader();d.readEntries(function(c){var d=c.length;if(d>0){var e=0;Array.prototype.forEach.call(c,function(c){c.isFile?c.file(function(c){c.date=c.lastModifiedDate,b+=c.size,a.push(c),++e===d&&(this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete())}.bind(this)):(d--,0===d&&(this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()))}.bind(this))}else this.table=a,this.total=0,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),c.bind(this))}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0;var a=this.storage.root.createReader();a.readEntries(function(a){var b=a.length;if(b>0){var d=0;Array.prototype.forEach.call(a,function(a){a.isFile?a.remove(function(){++d==b&&(this.filled=!1,this.loading=!1,this.getAll())}.bind(this),c.bind(this)):(b--,0===b&&(this.filled=!1,this.loading=!1,this.getAll()))}.bind(this))}else this.loading=!1}.bind(this),c.bind(this))}}},new e}]),app.factory("Quota",["FileSystem","$window",function(a,b){var c=b.navigator.temporaryStorage||b.navigator.webkitTemporaryStorage||b.navigator.mozTemporaryStorage||b.navigator.msTemporaryStorage||void 0,d=b.navigator.persistentStorage||b.navigator.webkitPersistentStorage||b.navigator.mozPersistentStorage||b.navigator.msPersistentStorage||void 0,e=function(a){alert("Error!",a),console.error("Quota Management Error",a),console.trace()},f=function(){return this.usage=0,this.quota=0,this.disp_usage=0,this.disp_quota=0,this.storage_type="TEMPORARY",this.storage=null,this.supported=!1,this.oncomplete=null,c&&d?(this.supported=!0,this.storage="TEMPORARY"===this.storage_type?c:d,this.request_usage(),void 0):(console.info("Quota Management API not supported on this browser"),void 0)};return f.prototype={change_file_system:function(){this.supported&&(this.storage="TEMPORARY"===this.storage_type?c:d,a.open(this.storage_type,this.quota,function(){this.request_usage()}.bind(this)))},request_quota:function(){this.supported&&this.storage.requestQuota(1024*this.disp_quota*1024,function(a){this.quota=a,this.disp_quota=~~(a/1024/1024),this.change_file_system()}.bind(this),e)},request_usage:function(){this.supported&&this.storage.queryUsageAndQuota(function(a,b){this.quota=b,this.usage=a,this.disp_quota=~~(b/1024/1024),this.disp_usage=~~(a/1024/1024),"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),e)}},new f}]),app.factory("IndexedDB",["$window",function(a){var b=function(a){"QuotaExceededError"==a.name&&(this.filled=!0,alert(a.message)),console&&(console.info("IndexedDB Error!"),console.error(a.message)),this.queue=[],this.loading=!1,this.getAll()},c=3,d=null,e=function(){var a=function(a){var c=new FileReader;c.onload=function(c){var f={name:a.name,size:a.size,date:a.lastModifiedDate.getTime(),payload:c.target.result},g=d.transaction(["entries"],"readwrite");g.oncomplete=function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),e.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),g.onerror=b.bind(this),g.onabort=function(a){b.bind(this)(a.target.error)}.bind(this);var h=g.objectStore("entries"),i=h.put(f);i.onerror=function(a){console.log(a)}}.bind(this),"text/plain"===a.type?c.readAsText(a):c.readAsDataURL(a)},c=this.queue.shift();c instanceof Blob?a.bind(this)(c):c.file(a.bind(this))},f=function(){if(this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,!a.indexedDB)return console.info("Indexed Database API not supported on this browser"),void 0;var e=a.indexedDB.open("BrowserStorageAbuser",c);e.onsuccess=function(a){d=a.target.result,this.supported=!0,this.getAll()}.bind(this),e.onerror=b.bind(this),e.onupgradeneeded=function(a){d=a.target.result,d.objectStoreNames.contains("entries")&&d.deleteObjectStore("entries"),d.createObjectStore("entries",{autoIncrement:!0}),console.info("upgraded IndexedDB")}.bind(this)};return f.prototype={add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),e.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],c=0;this.loading=!0;var e=d.transaction(["entries"],"readonly");e.oncomplete=function(){this.table=a,this.total=c,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),e.onerror=b.bind(this);var f=e.objectStore("entries").openCursor();f.onsuccess=function(b){var d=b.target.result;if(d){var e=d.value;c+=e.size,delete e.payload,a.push(e),d.continue()}}.bind(this),f.onerror=b.bind(this)}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0;var a=d.transaction(["entries"],"readwrite");a.oncomplete=function(){this.filled=!1,this.loading=!1,this.getAll()}.bind(this),a.onerror=b.bind(this);var c=a.objectStore("entries"),e=c.openCursor();e.onsuccess=function(a){var b=a.target.result;b&&(c.delete(b.key),b.continue())}.bind(this),e.onerror=b.bind(this)}}},new f}]),app.factory("WebSQL",["Quota","$window",function(a,b){var c=function(a){a.code===a.QUOTA_ERR&&(this.filled=!0,alert(a.message)),console&&(console.info("WebSQL Error!"),console.error(a.message)),this.queue=[],this.loading=!1,this.getAll()},d="1.0",e="BrowserStorageAbuser",f=null,g=function(){var a=function(a){var b=new FileReader;b.onload=function(b){var d=[a.name,a.size,a.lastModifiedDate.getTime(),b.target.result];f.transaction(function(a){a.executeSql("INSERT INTO entries (name, size, date, payload) VALUES(?, ?, ?, ?)",d,function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),g.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),function(a,b){return c.bind(this)(b),!1}.bind(this))}.bind(this),function(a){a.code===a.QUOTA_ERR&&c.bind(this)(a)}.bind(this),function(){console.log("Transaction successful.")}.bind(this))}.bind(this),"text/plain"===a.type?b.readAsText(a):b.readAsDataURL(a)},b=this.queue.shift();b instanceof Blob?a.bind(this)(b):b.file(a.bind(this))},h=function(){if(this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,!b.openDatabase)return console.info("WebSQL database not supported on this browser"),void 0;this.supported=!0;try{f=openDatabase(e,"",e,a&&a.quota||1048576)}catch(g){return 2==g?alert("Invalid database version!"):alert("Unknown error "+g+"."),void 0}f.version!==d?f.changeVersion(f.version,d,function(a){a.executeSql("CREATE TABLE entries (id          INTEGER PRIMARY KEY AUTOINCREMENT, name        TEXT, size        INTEGER, date        INTEGER, payload     TEXT)",[],function(){this.getAll(),console.info("Created new table on WebSQL")}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),function(a){throw console.error("WebSQL Error!",a),"WebSQL Error!"}.bind(this),function(){this.getAll(),console.info("upgraded WebSQL")}.bind(this)):this.getAll()};return h.prototype={add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),g.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=0;this.loading=!0,f.readTransaction(function(b){b.executeSql("SELECT * FROM entries",[],function(b,c){for(var d=[],e=0;e<c.rows.length;e++){var f={name:c.rows.item(e).name,size:c.rows.item(e).size,date:c.rows.item(e).date};a+=f.size,d.push(f)}this.table=d,this.total=a,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),c.bind(this))}},deleteAll:function(){this.supported&&!this.loading&&(this.table=[],this.loading=!0,f.transaction(function(a){a.executeSql("DELETE FROM entries",[],function(){this.filled=!1,this.loading=!1,this.getAll()}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),c.bind(this)))}},new h}]);var WebStorage=function(a){var b=a.charAt(0).toLowerCase()+a.substr(1),c=function(b){alert(b.message),console&&(console.info(a+" Error!"),console.error(b))},d=null,e=function(){var a=function(a){var c=new FileReader;c.onload=function(c){var d={name:a.name,size:a.size,date:a.lastModifiedDate.getTime(),payload:c.target.result};b.bind(this)(d)}.bind(this),"text/plain"===a.type?c.readAsText(a):c.readAsDataURL(a)},b=function(a){try{d.setItem(a.name,JSON.stringify(a))}catch(b){(b.code===b.QUOTA_EXCEEDED_ERR||1014===b.code)&&(this.filled=!0),this.queue=[],c(b)}finally{this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),e.bind(this)()):(this.loading=!1,this.getAll())}},f=this.queue.shift();switch(f.toString().replace(/\[object (.*?)\]/,"$1")){case"Blob":a.bind(this)(f);break;case"File":case"FileEntry":f.file(a.bind(this));break;default:b.bind(this)(f)}},f=function(){return this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,window[b]?(this.supported=!0,d=window[b],this.getAll(),void 0):(console.info(a+" not supported on this browser"),void 0)};return f.prototype={add:function(a){d&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),e.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],b=0;this.loading=!0;for(var c=0;c<d.length;c++){var e=d.key(c),f=d[e];try{f=JSON.parse(f)}catch(g){}finally{f.payload||(f={name:e,size:0,date:new Date,payload:f})}b+=f.size,delete f.payload,a.push(f)}setTimeout(function(){this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),0)}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0,this.filled=!1;for(var a=d.length,b=0;a>b;b++)try{d.removeItem(d.key(0))}catch(e){c(e)}this.loading=!1,this.getAll()}}},function(){return new f}};app.factory("LocalStorage",WebStorage("LocalStorage")),app.factory("SessionStorage",WebStorage("SessionStorage")),app.controller("MainCtrl",["$scope","$timeout","storages","Quota",function(a,b,c,d){a.storages=c;var e=function(){return window.performance&&performance.now?performance.now()+performance.timing.navigationStart:Date.now()};a.start=0,a.duration_log=[],a.time_lap=function(){var b=e();if(0!==a.start){var c=b-a.start;a.duration_log.length>0&&console.log(c/1e3,"sec"),a.start=b,a.duration_log.push(c)}else a.start=b},a.time_finish=function(){if(0!==a.start){var b=e(),c=b-a.start;console.log(c/1e3,"sec"),a.duration_log.push(c);for(var d=0,f=1;void 0!==a.duration_log[f];)d+=a.duration_log[f++];console.log("average:",d/a.duration_log.length/1e3,"sec"),a.start=0,a.duration_log=[]}},a.update=function(){a.$broadcast("update")},a.calc_quota=function(){d.request_usage()},a.set_working_storage=function(b){for(var c=0;c<a.storages.length;c++)a.storages[c].name===b&&(a.working_storage=a.storages[c].source)}}]),app.directive("quotaTable",["Quota",function(){return{restrict:"A",controller:function(a,b){a.source=b,a.source.oncomplete=function(){a.$$phase||a.$apply()},a.change_file_system=function(){a.source&&a.source.change_file_system(function(){a.update()})},a.request_quota=function(){a.source.request_quota(function(){a.update()})}},link:function(a){a.$on("update",function(){a.source.request_usage()})}}}]),app.directive("storageTable",["storages","FileSystem","IndexedDB","WebSQL","LocalStorage","SessionStorage",function(a){for(var b=1;b<arguments.length;b++)a[b-1].source=arguments[b];var c=function(a,b){var d=a.createReader();d.readEntries(function(a){Array.prototype.forEach.call(a,function(a){a.isFile?b(a):c(a,b)})})};return{restrict:"E",templateUrl:"storage-table.html",controller:function(a,b){a.source=b[a.$index].source,a.source.onprogress=function(b,c){a.time_lap(),a.$emit("progress",b,c)},a.source.oncomplete=function(){a.time_finish(),a.calc_quota(),a.$$phase||a.$apply()},a.upload=function(){a.file_input.click()},a.open_fill_storage=function(){a.set_working_storage(a.data.name),a.$emit("open_fill_storage")},a.delete_all=function(){confirm("Do you really want to delete all?")&&a.source.deleteAll()}},link:function(a,b){a.hover=!1,a.total_size="0.0MB",a.file_input=b.find("input")[0],a.$watch("source.loading",function(b){b||a.$emit("close_progress")}),a.$on("update",function(){console.log(a.data.name+" is updating"),a.time_lap(),a.source.getAll()}),b.bind("dragleave",function(b){b.preventDefault(),a.hover=!1,a.$apply()}),b.bind("dragover",function(b){b.preventDefault(),a.hover=!0,a.$apply()}),b.bind("drop",function(b){if(a.hover=!1,b.preventDefault(),!a.source.loading){var d=b.originalEvent.dataTransfer;d.items?Array.prototype.forEach.call(d.items,function(b){if(b){var d=b.webkitGetAsEntry();d.isDirectory?c(d,a.source.add.bind(a.source)):(a.time_lap(),a.source.add(d))}}):Array.prototype.forEach.call(d.files,function(b){a.source.add(b)}),a.$emit("progress",0,10),a.$apply()}})}}}]),app.directive("fillStorage",function(){var a=window.Blob||window.WebKitBlob||window.MozBlob||window.MsBlob||void 0,b=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MsBlobBuilder||void 0;return{restrict:"E",templateUrl:"fill-storage.html",controller:function(c){c.chunk_selections=[5120,51200,512e3,5242880,52428800,524288e3,1073741824],c.chunk_size=5242880,c.quantity=1,c.fill=function(){c.$emit("close_fill_storage");var d=c.chunk_size/4,e=new Array(d+1).join("aあ");c.time_lap();for(var f=0;f<c.quantity;f++){var g=null;if(void 0!==a||void 0!==b)try{g=new a([e],{type:"text/plain"})}catch(h){var i=new b;i.append(e),g=i.getBlob({type:"text/plain"})}else g={size:c.chunk_size,payload:e};g.lastModifiedDate=new Date,g.name=~~(1e5*Math.random())+1e5+".txt",c.time_lap(),c.working_storage.add(g)}}},link:function(a,b){a.dialog=b.find(">div"),a.$on("open_fill_storage",function(){a.dialog.modal("show")}),a.$on("close_fill_storage",function(){a.dialog.modal("hide")})}}}),app.directive("storageProgress",function(){return{restrict:"E",templateUrl:"storage-progress.html",link:function(a,b){a.value=0,a.max=0,a.progress=b.find(">div"),a.$on("progress",function(c,d,e){a.value=d,a.max=e,"none"==a.progress.css("display")&&(b.find(".progress-bar").css("width","0%"),a.progress.modal("show")),0!==d&&d===e&&setTimeout(function(){a.progress.modal("hide")},2e3),a.$$phase||a.$apply()}),a.$on("close_progress",function(){a.progress.modal("hide")})}}}),app.filter("size",function(){return function(a){if("number"!=typeof a)return"-- KB";var b=a/1024,c=b/1024,d=c/1024;return d>1?d.toFixed(1)+"GB":c>1?c.toFixed(1)+"MB":b.toFixed(1)+"KB"}});var app=angular.module("BrowserStorageAbuser",[]);app.value("storages",[{name:"FileSystem",desc:"The File System API simulates a local file system that web apps can navigate around. You can develop apps that can read, write, and create files and directories in a virtual, sandboxed file system.",link:"https://developer.mozilla.org/docs/WebGuide/API/File_System"},{name:"IndexedDB",desc:"IndexedDB is an API for client-side storage of significant amounts of structured data and for high performance searches on this data using indexes. While DOM Storage is useful for storing smaller amounts of data, it is less useful for storing larger amounts of structured data. IndexedDB provides a solution.",link:"https://developer.mozilla.org/docs/IndexedDB"},{name:"WebSQL",desc:"Web SQL Database is a web page API for storing data in databases that can be queried using a variant of SQL. The API is supported by Google Chrome, Opera, Safari and the Android Browser. The W3C Web Applications Working Group ceased working on the specification in November 2010, citing a lack of independent implementations (i.e., the use of a database system other than SQLite as the backend) as the reason the specification could not move forward to become a W3C Recommendation. One potential alternative storage standard is IndexedDB.",link:"http://wikipedia.org/wiki/Web_SQL_Database"},{name:"LocalStorage",desc:"DOM Storage is the name given to the set of storage-related features first introduced in the Web Applications 1.0 specification, and now split off into its own W3C Web Storage specification. DOM Storage is designed to provide a larger, more secure, and easier-to-use alternative to storing information in cookies. It was first introduced with Firefox 2 and Safari 4.",link:"https://developer.mozilla.org/docs/Web/Guide/API/DOM/Storage"},{name:"SessionStorage",desc:"DOM Storage is the name given to the set of storage-related features first introduced in the Web Applications 1.0 specification, and now split off into its own W3C Web Storage specification. DOM Storage is designed to provide a larger, more secure, and easier-to-use alternative to storing information in cookies. It was first introduced with Firefox 2 and Safari 4.",link:"https://developer.mozilla.org/docs/Web/Guide/API/DOM/Storage"}]),app.factory("FileSystem",["$window",function(a){var b=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,c=function(a){a.code===a.QUOTA_EXCEEDED_ERR&&(this.filled=!0,alert(a.message)),console&&(console.info("FileSystem Error!"),console.error(a)),this.queue=[],this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()},d=function(){var a=this.queue.shift();this.storage.root.getFile(a.name,{create:!0,exclusive:!1},function(b){b.createWriter(function(b){b.onwriteend=function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),d.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),b.onerror=c.bind(this),a instanceof Blob?b.write(a):a.file(function(a){b.write(a)})}.bind(this))}.bind(this),c.bind(this))},e=function(){return this.supported=!1,this.storage=null,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,b?(this.supported=!0,this.open("TEMPORARY",0,function(){this.getAll()}.bind(this)),void 0):(console.info("FileSystem API not supported on this browser"),void 0)};return e.prototype={open:function(d,e,f){this.supported&&b(a[d],e,function(a){this.supported=!0,this.storage=a,"function"==typeof f&&f()}.bind(this),c)},add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading||(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),d.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],b=0;this.loading=!0;var d=this.storage.root.createReader();d.readEntries(function(c){var d=c.length;if(d>0){var e=0;Array.prototype.forEach.call(c,function(c){c.isFile?c.file(function(c){c.date=c.lastModifiedDate,b+=c.size,a.push(c),++e===d&&(this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete())}.bind(this)):(d--,0===d&&(this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()))}.bind(this))}else this.table=a,this.total=0,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),c.bind(this))}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0;var a=this.storage.root.createReader();a.readEntries(function(a){var b=a.length;if(b>0){var d=0;Array.prototype.forEach.call(a,function(e){e.isFile?e.remove(function(){++d==a.length&&(this.filled=!1,this.loading=!1,this.getAll())}.bind(this),c.bind(this)):(b--,0===b&&(this.filled=!1,this.loading=!1,this.getAll()))}.bind(this))}else this.loading=!1}.bind(this),c.bind(this))}}},new e}]),app.factory("Quota",["FileSystem","$window",function(a,b){var c=b.navigator.temporaryStorage||b.navigator.webkitTemporaryStorage||b.navigator.mozTemporaryStorage||b.navigator.msTemporaryStorage||void 0,d=b.navigator.persistentStorage||b.navigator.webkitPersistentStorage||b.navigator.mozPersistentStorage||b.navigator.msPersistentStorage||void 0,e=function(a){alert("Error!",a),console.error("Quota Management Error",a),console.trace()},f=function(){return this.usage=0,this.quota=0,this.disp_usage=0,this.disp_quota=0,this.storage_type="TEMPORARY",this.storage=null,this.supported=!1,this.oncomplete=null,c&&d?(this.supported=!0,this.storage="TEMPORARY"===this.storage_type?c:d,this.request_usage(),void 0):(console.info("Quota Management API not supported on this browser"),void 0)};return f.prototype={change_file_system:function(){this.supported&&(this.storage="TEMPORARY"===this.storage_type?c:d,a.open(this.storage,this.quota,function(){this.request_usage()}.bind(this)))},request_quota:function(){this.supported&&this.storage.requestQuota(1024*this.disp_quota*1024,function(a){this.quota=a,this.disp_quota=~~(a/1024/1024),this.change_file_system()}.bind(this),e)},request_usage:function(){this.supported&&this.storage.queryUsageAndQuota(function(a,b){this.quota=b,this.usage=a,this.disp_quota=~~(b/1024/1024),this.disp_usage=~~(a/1024/1024),"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),e)}},new f}]),app.factory("IndexedDB",["$window",function(a){var b=function(a){"QuotaExceededError"==a.name&&(this.filled=!0,alert("Quota Exceeded!")),console&&(console.info("IndexedDB Error!"),console.error(a)),this.queue=[],this.loading=!1,this.getAll()},c=3,d=null,e=function(){var a=function(a){var c=new FileReader;c.onload=function(c){var f={name:a.name,size:a.size,date:a.lastModifiedDate.getTime(),payload:c.target.result},g=d.transaction(["entries"],"readwrite");g.oncomplete=function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),e.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),g.onerror=b.bind(this),g.onabort=function(a){b.bind(this)(a.target.error)}.bind(this);var h=g.objectStore("entries");h.put(f)}.bind(this),"text/plain"===a.type?c.readAsText(a):c.readAsDataURL(a)},c=this.queue.shift();c instanceof Blob?a.bind(this)(c):c.file(a.bind(this))},f=function(){if(this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,!a.indexedDB)return console.info("Indexed Database API not supported on this browser"),void 0;var e=a.indexedDB.open("BrowserStorageAbuser",c);e.onsuccess=function(a){d=a.target.result,this.supported=!0,this.getAll()}.bind(this),e.onerror=b.bind(this),e.onupgradeneeded=function(a){d=a.target.result,d.objectStoreNames.contains("entries")&&d.deleteObjectStore("entries"),d.createObjectStore("entries",{autoIncrement:!0}),console.info("upgraded IndexedDB")}.bind(this)};return f.prototype={add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),e.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],c=0;this.loading=!0;var e=d.transaction(["entries"],"readonly");e.oncomplete=function(){this.table=a,this.total=c,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),e.onerror=b.bind(this);var f=e.objectStore("entries").openCursor();f.onsuccess=function(b){var d=b.target.result;if(d){var e=d.value;c+=e.size,delete e.payload,a.push(e),d.continue()}}.bind(this),f.onerror=b.bind(this)}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0;var a=d.transaction(["entries"],"readwrite");a.oncomplete=function(){this.filled=!1,this.loading=!1,this.getAll()}.bind(this),a.onerror=b.bind(this);var c=a.objectStore("entries"),e=c.openCursor();e.onsuccess=function(a){var b=a.target.result;b&&(c.delete(b.key),b.continue())}.bind(this),e.onerror=b.bind(this)}}},new f}]),app.factory("WebSQL",["Quota","$window",function(a,b){var c=function(a){a.code===a.QUOTA_ERR&&(this.filled=!0,alert(a.message)),console&&(console.info("WebSQL Error!"),console.error(a.message)),this.queue=[],this.loading=!1,this.getAll()},d="1.0",e="BrowserStorageAbuser",f=null,g=function(){var a=function(a){var b=new FileReader;b.onload=function(b){var d=[a.name,a.size,a.lastModifiedDate.getTime(),b.target.result];f.transaction(function(a){a.executeSql("INSERT INTO entries (name, size, date, payload) VALUES(?, ?, ?, ?)",d,function(){this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),g.bind(this)()):(this.loading=!1,this.getAll())}.bind(this),function(a,b){return c.bind(this)(b),!1}.bind(this))}.bind(this),function(a){a.code===a.QUOTA_ERR&&c.bind(this)(a)}.bind(this),function(){console.log("Transaction successful.")}.bind(this))}.bind(this),"text/plain"===a.type?b.readAsText(a):b.readAsDataURL(a)},b=this.queue.shift();b instanceof Blob?a.bind(this)(b):b.file(a.bind(this))},h=function(){if(this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,!b.openDatabase)return console.info("WebSQL database not supported on this browser"),void 0;this.supported=!0;try{f=openDatabase(e,"",e,a&&a.quota||1048576)}catch(g){return 2==g?alert("Invalid database version!"):alert("Unknown error "+g+"."),void 0}f.version!==d?f.changeVersion(f.version,d,function(a){a.executeSql("CREATE TABLE entries (id          INTEGER PRIMARY KEY AUTOINCREMENT, name        TEXT, size        INTEGER, date        INTEGER, payload     TEXT)",[],function(){this.getAll(),console.info("Created new table on WebSQL")}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),function(a){throw console.error("WebSQL Error!",a),"WebSQL Error!"}.bind(this),function(){this.getAll(),console.info("upgraded WebSQL")}.bind(this)):this.getAll()};return h.prototype={add:function(a){this.supported&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),g.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=0;this.loading=!0,f.readTransaction(function(b){b.executeSql("SELECT * FROM entries",[],function(b,c){for(var d=[],e=0;e<c.rows.length;e++){var f={name:c.rows.item(e).name,size:c.rows.item(e).size,date:c.rows.item(e).date};a+=f.size,d.push(f)}this.table=d,this.total=a,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),c.bind(this))}},deleteAll:function(){this.supported&&!this.loading&&(this.table=[],this.loading=!0,f.transaction(function(a){a.executeSql("DELETE FROM entries",[],function(){this.filled=!1,this.loading=!1,this.getAll()}.bind(this),function(a,b){c.bind(this)(b)}.bind(this))}.bind(this),c.bind(this)))}},new h}]);var WebStorage=function(a){var b=a.charAt(0).toLowerCase()+a.substr(1),c=function(b){alert(b.message),console&&(console.info(a+" Error!"),console.error(b))},d=null,e=function(){var a=function(a){var c=new FileReader;c.onload=function(c){var d={name:a.name,size:a.size,date:a.lastModifiedDate.getTime(),payload:c.target.result};b.bind(this)(d)}.bind(this),"text/plain"===a.type?c.readAsText(a):c.readAsDataURL(a)},b=function(a){try{d.setItem(a.name,JSON.stringify(a))}catch(b){(b.code===b.QUOTA_EXCEEDED_ERR||1014===b.code)&&(this.filled=!0),this.queue=[],c(b)}finally{this.queue.length>0?("function"==typeof this.onprogress&&this.onprogress(++this.value,this.max),e.bind(this)()):(this.loading=!1,this.getAll())}},f=this.queue.shift();switch(f.toString().replace(/\[object (.*?)\]/,"$1")){case"Blob":a.bind(this)(f);break;case"File":case"FileEntry":f.file(a.bind(this));break;default:b.bind(this)(f)}},f=function(){return this.supported=!1,this.filled=!1,this.loading=!1,this.oncomplete=null,this.onprogress=null,this.queue=[],this.value=0,this.max=0,this.table=[],this.total=0,window[b]?(this.supported=!0,d=window[b],this.getAll(),void 0):(console.info(a+" not supported on this browser"),void 0)
};return f.prototype={add:function(a){d&&(this.queue.push(a),this.max=this.queue.length,this.loading===!1&&(this.value=0,this.loading=!0,"function"==typeof this.onprogress&&this.onprogress(this.value,this.max),e.bind(this)()))},getAll:function(){if(this.supported&&!this.loading){var a=[],b=0;this.loading=!0;for(var c=0;c<d.length;c++){var e=d.key(c),f=d[e];try{f=JSON.parse(f)}catch(g){}finally{f.payload||(f={name:e,size:0,date:new Date,payload:f})}b+=f.size,delete f.payload,a.push(f)}setTimeout(function(){this.table=a,this.total=b,this.loading=!1,"function"==typeof this.oncomplete&&this.oncomplete()}.bind(this),0)}},deleteAll:function(){if(this.supported&&!this.loading){this.table=[],this.loading=!0,this.filled=!1;for(var a=d.length,b=0;a>b;b++)try{d.removeItem(d.key(0))}catch(e){c(e)}this.loading=!1,this.getAll()}}},function(){return new f}};app.factory("LocalStorage",WebStorage("LocalStorage")),app.factory("SessionStorage",WebStorage("SessionStorage")),app.controller("MainCtrl",["$scope","$timeout","storages","Quota",function(a,b,c,d){a.storages=c;var e=function(){return window.performance&&performance.now?performance.now()+performance.timing.navigationStart:Date.now()};a.start=0,a.duration_log=[],a.time_lap=function(){var b=e();if(0!==a.start){var c=b-a.start;a.duration_log.length>0&&console.log(c/1e3,"sec"),a.start=b,a.duration_log.push(c)}else a.start=b},a.time_finish=function(){if(0!==a.start){var b=e(),c=b-a.start;console.log(c/1e3,"sec"),a.duration_log.push(c);for(var d=0,f=1;void 0!==a.duration_log[f];)d+=a.duration_log[f++];console.log("average:",d/a.duration_log.length/1e3,"sec"),a.start=0,a.duration_log=[]}},a.update=function(){a.$broadcast("update")},a.calc_quota=function(){d.request_usage()},a.set_working_storage=function(b){for(var c=0;c<a.storages.length;c++)a.storages[c].name===b&&(a.working_storage=a.storages[c].source)}}]),app.directive("quotaTable",["Quota",function(){return{restrict:"A",controller:function(a,b){a.source=b,a.source.oncomplete=function(){a.$$phase||a.$apply()},a.change_file_system=function(){a.source&&a.source.change_file_system(function(){a.update()})},a.request_quota=function(){a.source.request_quota(function(){a.update()})}},link:function(a){a.$on("update",function(){a.source.request_usage()})}}}]),app.directive("storageTable",["storages","FileSystem","IndexedDB","WebSQL","LocalStorage","SessionStorage",function(a){for(var b=1;b<arguments.length;b++)a[b-1].source=arguments[b];var c=function(a,b){var d=a.createReader();d.readEntries(function(a){Array.prototype.forEach.call(a,function(a){a.isFile?b(a):c(a,b)})})};return{restrict:"E",templateUrl:"storage-table.html",controller:function(a,b){a.source=b[a.$index].source,a.source.onprogress=function(b,c){a.time_lap(),a.$emit("progress",b,c)},a.source.oncomplete=function(){a.time_finish(),a.calc_quota(),a.$$phase||a.$apply()},a.upload=function(){a.file_input.click()},a.open_fill_storage=function(){a.set_working_storage(a.data.name),a.$emit("open_fill_storage")},a.delete_all=function(){confirm("Do you really want to delete all?")&&a.source.deleteAll()}},link:function(a,b){a.hover=!1,a.total_size="0.0MB",a.file_input=b.find("input")[0],a.file_input.onchange=function(b){Array.prototype.forEach.call(b.target.files,function(b){a.time_lap(),a.source.add(b)})},a.$watch("source.loading",function(b){b||a.$emit("close_progress")}),a.$on("update",function(){console.log(a.data.name+" is updating"),a.time_lap(),a.source.getAll()}),b.bind("dragleave",function(b){b.preventDefault(),a.hover=!1,a.$apply()}),b.bind("dragover",function(b){b.preventDefault(),a.hover=!0,a.$apply()}),b.bind("drop",function(b){if(a.hover=!1,b.preventDefault(),!a.source.loading){var d=b.originalEvent.dataTransfer;d.items?Array.prototype.forEach.call(d.items,function(b){if(b){var d=b.webkitGetAsEntry();d.isDirectory?c(d,a.source.add.bind(a.source)):(a.time_lap(),a.source.add(d))}}):Array.prototype.forEach.call(d.files,function(b){a.source.add(b)}),a.$emit("progress",0,10),a.$apply()}})}}}]),app.directive("fillStorage",function(){var a=window.Blob||window.WebKitBlob||window.MozBlob||window.MsBlob||void 0,b=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MsBlobBuilder||void 0;return{restrict:"E",templateUrl:"fill-storage.html",controller:function(c){c.chunk_selections=[5120,51200,512e3,5242880,52428800,524288e3,1073741824],c.chunk_size=5242880,c.quantity=1,c.fill=function(){c.$emit("close_fill_storage");var d=c.chunk_size/4,e=new Array(d+1).join("aあ");c.time_lap();for(var f=0;f<c.quantity;f++){var g=null;if(void 0!==a||void 0!==b)try{g=new a([e],{type:"text/plain"})}catch(h){var i=new b;i.append(e),g=i.getBlob({type:"text/plain"})}else g={size:c.chunk_size,payload:e};g.lastModifiedDate=new Date,g.name=~~(1e5*Math.random())+1e5+".txt",c.time_lap(),c.working_storage.add(g)}}},link:function(a,b){a.dialog=b.find(">div"),a.$on("open_fill_storage",function(){a.dialog.modal("show")}),a.$on("close_fill_storage",function(){a.dialog.modal("hide")})}}}),app.directive("storageProgress",function(){return{restrict:"E",templateUrl:"storage-progress.html",link:function(a,b){a.value=0,a.max=0,a.progress=b.find(">div"),a.$on("progress",function(c,d,e){a.value=d,a.max=e,"none"==a.progress.css("display")&&(b.find(".progress-bar").css("width","0%"),a.progress.modal("show")),0!==d&&d===e&&setTimeout(function(){a.progress.modal("hide")},2e3),a.$$phase||a.$apply()}),a.$on("close_progress",function(){a.progress.modal("hide")})}}}),app.filter("size",function(){return function(a){if("number"!=typeof a)return"-- KB";var b=a/1024,c=b/1024,d=c/1024;return d>1?d.toFixed(1)+"GB":c>1?c.toFixed(1)+"MB":b.toFixed(1)+"KB"}}),function(a,b){var c={version:"","auto-init":"yes","root-path":"/","preferred-storage":"auto","debug-mode":"no"},d=null,e="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f="PortableCache",g="NOT_SUPPORTED",h=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,i=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB||void 0,j=a.openDatabase||void 0,k=a.localStorage||void 0,l=a.Blob||a.WebKitBlob||a.MozBlob||a.MsBlob||void 0,m=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MsBlobBuilder||void 0,n=(a.URL||a.webkitURL||a.mozURL||a.msURL||a.oURL||void 0,a.document.addEventListener?function(a,b,c){a.addEventListener(b,c)}:function(a,b,c){a.attachEvent("on"+b,c)}),o=a.document.removeEventListener?function(a,b,c){a.removeEventListener(b,c)}:function(a,b,c){a.detachEvent("on"+b,c)};Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var p=function(a){for(var b,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",e=-6,f=0,g=0,h=0;g<a.length||e>-6;)0>e&&(g<a.length?(b=a[g++],h+=8):b=0,f=(255&f)<<8|255&b,e+=8),d+=c.charAt(h>0?f>>e&63:64),e-=6,h-=6;return d},q=function(a,b){var c=null;if(a instanceof l)return a;if(l)try{c=new l([a],{type:b})}catch(d){var e=new m;e.append(a),c=e.getBlob(b)}else if(m){var e=new m;e.append(a),c=e.getBlob(b)}return c},r=function(a){if(0===a.indexOf("http")||0===a.indexOf("//"))return a;var b=function(a){return""===a?!1:!0},c=location.pathname.split("/").filter(b),d=a.split("/");do switch(d[0]){case"..":c=c.slice(0,-1),d=d.slice(1);break;case".":case"":d=d.slice(1)}while(".."==d[0]);return d=c.concat(d),"/"+d.join("/")},s=function(b,c,d,e){if(null===c)return b;d=d||a.devicePixelRatio,e=e||a.innerWidth;var f,g=c.split(/\s*,\s*/g),h=[],i=0;for(h.push({url:b,w:1/0,x:1}),i=0;i<g.length;i++){var j=g[i].split(/\s+/g);if(!(j.length<2)){for(var k,l=j.shift(),m={url:l,x:1,w:1/0};k=j.shift(),void 0!==k;){var n=k.match(/^([0-9\.]+)(w|x)$/);n&&3===n.length&&(m[n[2]]=1*n[1])}h.push(m)}}var o=1/0,p=0;for(i=0;i<h.length;i++)f=h[i],e<=f.w&&f.w<=o&&(o=f.w);for(i=0;i<h.length;i++)f=h[i],f.w===o&&(0===p?p=f.x:d<=f.x&&(d>p||f.x<p)&&(p=f.x));for(i=0;i<h.length;i++)if(f=h[i],f.x==p&&f.w==o)return f.url;return b},t=function(c){for(var d=a.pageYOffset||b.documentElement.scrollTop,e=a.innerHeight||b.documentElement.clientHeight,f=d-e/4,g=d+~~(1.25*e),h=0;h<c.length;h++){var i=c[h],j=i.elem.offsetTop,k=i.elem.offsetHeight;(f>=j+k||g>=j)&&(i.load(function(a){a.constructDOM()}),c.splice(h--,1))}},u={getItem:function(a){return a&&this.hasItem(a)?unescape(b.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},setItem:function(a,c,d,e,f,g){if(a&&!/^(?:expires|max\-age|path|domain|secure)$/i.test(a)){var h="";if(d)switch(d.constructor){case Number:h=1/0===d?"; expires=Tue, 19 Jan 2038 03:14:07 GMT":"; max-age="+d;break;case String:h="; expires="+d;break;case Date:h="; expires="+d.toGMTString()}b.cookie=escape(a)+"="+escape(c)+h+(f?"; domain="+f:"")+(e?"; path="+e:"")+(g?"; secure":"")}},removeItem:function(a,c){a&&this.hasItem(a)&&(b.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; path="+c:""))},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(b.cookie)},keys:function(){for(var a=b.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),c=0;c<a.length;c++)a[c]=unescape(a[c]);return a}},v=function(a){if(this.src="",this.content="",this.mimetype="",this.lazyload=!1,a.nodeName){this.tag=a.nodeName.toLowerCase(),this.elem=a;var b=a.getAttribute("data-cache-url"),d=a.getAttribute("data-cache-srcset");this.url=c.version!=g?r(s(b,d)):s(b,d);var f=a.getAttribute("data-cache-version");this.version=null!==f?f:c.version,this.async=null===a.getAttribute("async")?!1:!0,this.type=/^(img|audio|video)/.test(this.tag)?"binary":"text"}else this.tag=a.tag||"",this.elem=null,this.url=r(a.url),this.version="string"==typeof a.version?a.version:c.version,this.type=a.type||"text";"img"==this.tag&&c.version!=g&&(this.elem.src=e,this.lazyload=null!==a.getAttribute("lazyload")?!0:!1)};v.prototype={load:function(a){a="function"!=typeof a?function(){}:a;var b=function(b){__debug&&console.log("[%s] %s falling back.",this.url,b),a(this)};""===this.version||c.version==g?(__debug&&console.log("[%s] fallback without checking cache.",this.url),a(this)):null===c["prev-version"]?(__debug&&console.log("[%s] no version found. fetching.",this.url),this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this))):this.readCache(function(c){c?c.version!==this.version?(__debug&&console.log("[%s] deprecated cache found. fetching...",this.url),this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!0,a,b.bind(this))}.bind(this),b.bind(this))):(this.src=c.src||"",this.content=c.content||"",this.mimetype=c.mimetype,__debug&&console.log("[%s] cache found. loading.",this.url),a(this)):(__debug&&console.log("[%s] cache not found. fetching...",this.url),this.fetch(function(c){this.content=c.content,this.mimetype=c.mimetype,this.createCache(!1,a,b.bind(this))}.bind(this),b.bind(this)))}.bind(this))},readCache:function(a){d?d.get(this,a,function(b){__debug&&console.error("[%s] %s",this.url,b),a(null)}):(__debug&&console.error("[%s] storage not ready",this.url),a(null))},createCache:function(a,b,c){var e=a&&d instanceof z?"update":"set";if(!d)return"function"==typeof c&&c("storage not ready"),void 0;var f=this;d instanceof x?(__debug&&console.log("[%s] creating Blob cache in FileSystem.",f.url),d.set(f,b,c)):this.getContentAs("text",function(a){f.content=a,__debug&&console.log("[%s] creating DataURL cache.",f.url),d[e](f,b,c,function(){__debug&&console.log("[%s] quota error. second try.",f.url),d[e](f,b,c,function(){c("second quota error. giving up.")})})})},removeCache:function(a,b){d?d.remove(this):"function"==typeof b&&b("storage not ready.")},fetch:function(b,c){var d=new XMLHttpRequest,e="string"==typeof d.responseType;d.open("GET",this.url,!0),"binary"==this.type?e?(d.responseType="blob",d.responseType="blob"!==d.responseType?"arraybuffer":"blob"):d.overrideMimeType?d.overrideMimeType("text/plain; charset=x-user-defined"):c("binary not supported on this browser."):"json"==this.type&&(d.responseType="json",d.responseType="json"!=d.responseType?"text":"json"),d.onreadystatechange=function(){if(4===d.readyState){var f={};if(200===d.status||304===d.status){if(f.mimetype=d.getResponseHeader("Content-Type").replace(/^(.*?);.*$/g,"$1"),"binary"==this.type)if(e)"blob"==d.responseType?(f.content=d.response,__debug&&console.log("[%s] fetched binary as Blob.",this.url)):"arraybuffer"==d.responseType&&(f.content=q(d.response,f.mimetype),__debug&&console.log("[%s] fetched binary as ArrayBuffer.",this.url));else if("undefined"!=typeof VBArray)f.content=new VBArray(d.responseBody).toArray(),__debug&&console.log("[%s] fetched binary using VBArray.",this.url);else{for(var g=[],h=d.responseText,i=0;i<h.length;i++){var j=h.charCodeAt(i);g.push(255&j)}f.content="data:"+f.mimetype+";base64,"+p(g),__debug&&console.log("[%s] fetched binary using text manipulation.",this.url)}else if("json"==this.type)if(e)f.content=d.response;else try{f.content=JSON.parse(d.responseText)}catch(k){c("Unparsable JSON response")}else f.content=d.responseText,__debug&&console.log("[%s] fetched text content.",this.url);b(f)}else 0===d.status?-1===this.url.indexOf(a.location.origin)?c("XMLHttpRequest was not allowed because of Access-Control-Allow-Origin."):c("XMLHttpRequest unknown error."):c("XMLHttpRequest error: "+d.status)}}.bind(this),d.send()},constructDOM:function(a){switch(a="function"!=typeof a?function(){}:a,this.src||"string"!=typeof this.content||0!==this.content.indexOf("data:")||(this.src=this.content),this.tag){case"audio":case"video":case"img":this.src?(this.elem.setAttribute("src",this.src),__debug&&console.log("[%s] replaced src of <%s>",this.url,this.tag),a()):(this.elem.setAttribute("src",this.url),__debug&&console.log("[%s] fallback to <%s>",this.url,this.tag),n(this.elem,"load",a));break;case"script":if(this.src)this.elem.async=this.async,this.elem.setAttribute("src",this.src),__debug&&console.log("[%s] replaced src of <script>",this.url),n(this.elem,"load",a);else{if(this.content)return this.tag="script",this.elem=b.createElement("script"),this.elem.async=this.async,this.elem.textContent=this.content,b.head.appendChild(this.elem),__debug&&console.log("[%s] inlined to <script>",this.url),a(),void 0;this.elem.async=this.async,this.elem.setAttribute("src",this.url),__debug&&console.log("[%s] fallback to <script>",this.url),n(this.elem,"load",a)}break;case"link":this.src?(this.elem.setAttribute("href",this.src),__debug&&console.log("[%s] replaced href of <link>",this.url),a()):this.content&&"stylesheet"==this.elem.rel?(this.tag="style",this.elem=b.createElement("style"),this.elem.textContent=this.content,b.head.appendChild(this.elem),__debug&&console.log("[%s] inserted <style>",this.url),a()):(this.elem.setAttribute("href",this.url),__debug&&console.log("[%s] fallback to <link>",this.url),n(this.elem,"load",a))}},getContentAs:function(a,b,c){c="function"!=typeof c?function(){}:c;var d=l?new FileReader:null;switch(""==this.content&&(__debug&&console.error("[%s] content not loaded.",this.url),c("content not loaded.")),a){case"text":d&&this.content instanceof l?(__debug&&console.log("[%s] converting Blob to DataURL using FileReader.",this.url),d.onload=function(a){b(a.target.result)}.bind(this),d.readAsDataURL(this.content)):this.content instanceof Array?(__debug&&console.log("[%s] converting Blob to DataURL with manipulation.",this.url),b("data:"+this.mimetype+";base64,"+p(this.content))):"string"==typeof this.content&&b(this.content);break;case"arraybuffer":if(d&&this.content instanceof l)__debug&&console.log("[%s] converting Blob to ArrayBuffer using FileReader.",this.url),d.onload=function(a){b(a.target.result)}.bind(this),d.readAsArrayBuffer(this.content);else if(atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(e.buffer)}else __debug&&console.error("[%s] ArrayBuffer not supported on this browser.",this.url),c("ArrayBuffer not supported on this browser.");break;case"blob":if(this.content instanceof l)b(this.content);else if(d&&ArrayBuffer&&atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var e=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(q(e.buffer,this.mimetype))}else __debug&&console.error("[%s] Blob not supported on this browser.",this.url),c("Blob not supported on this browser.")}}};var w=function(){this.entries=[],this.lazyload=[],c=this.parseConfig(),c["prev-version"]=u.getItem("pcache_version"),__debug="undefined"==typeof __debug&&"no"!==c["debug-mode"]&&a.console?!0:!1,__debug&&console.log("Configuration loaded:",c);var e="no"!=c["auto-init"]?this.bootstrap.bind(this):function(){};if(c["prev-version"]==g||void 0===b.querySelectorAll||void 0===b.textContent||void 0===b.head)__debug&&console.log("This browser is not supported."),c.version=g,n(a,"load",e);else{var f=function(f){__debug&&console.log("%s Falling back.",f),d=null,"no"!=c["auto-init"]&&("complete"==b.readyState||"interactive"==b.readyState||"loaded"==b.readyState?this.bootstrap():n(a,"load",e))},l=c["preferred-storage"];d="filesystem"==l||h&&"auto"==l?new x(e,f.bind(this)):"idb"==l||i&&"auto"==l?new y(e,f.bind(this)):"sql"==l||j&&"auto"==l?new z(e,f.bind(this)):"localstorage"==l||k&&"auto"==l?new A(e,f.bind(this)):void 0,d||(__debug&&console.log("None of storages are available. Falling back."),n(a,"load",e))}};w.prototype={bootstrap:function(){var d=function(){this.lazyload.length?t(this.lazyload):(o(b,"scroll",d),__debug&&console.log("lazyload done. removed `scroll` event"))}.bind(this);b.body.style.display="none",this.queryTags(["link","script"],function(){if(b.body.style.display="block",c.version!=g){var e;if(b.createEvent?(e=b.createEvent("HTMLEvents"),e.initEvent("pcache-ready",!0,!1)):e=new Event("pcache-ready",{bubbles:!0,cancelable:!1}),b.dispatchEvent(e),__debug&&a.performance){var f=a.performance.timing.loadEventStart-a.performance.timing.requestStart;__debug&&console.log("pcache-ready:",f/1e3,"sec"),console.timeStamp&&console.timeStamp("pcache-ready")}}this.queryTags(["img","audio","video"],function(){this.lazyload.length>0&&n(b,"scroll",d)}.bind(this))}.bind(this)),u.setItem("pcache_version",c.version,null,c["root-path"])},resolveTag:function(a,c){for(var d=b.getElementsByTagName(a),e=d.length,f=0,g=0,h=0,i=[],j=[],k=function(){g++,f===g&&"function"==typeof c&&c()},l=0;e>l;l++)if(null!==d[l].getAttribute("data-cache-url")){f++;var m=new v(d[l]);this.entries.push(m),m.lazyload?(f--,this.lazyload.push(m)):("script"!=m.tag||m.async||i.push(m),m.load(function(a){if("script"!=a.tag||a.async)a.constructDOM(k);else{var b=i.indexOf(a);if(j[b]=a,b===h)for(;j[h];)i[h++].constructDOM(k)}}))}0===f&&"function"==typeof c&&c()},queryTags:function(a,b){for(var c=0,d=a.length;a.length;)this.resolveTag(a.shift(),function(){++c==d&&"function"==typeof b&&b()})},parseConfig:function(){var a=null;if(b.querySelector)a=b.querySelector('meta[name="portable-cache"]');else for(var d=b.getElementsByTagName("meta"),e=0;e<d.length;e++){var f=d[e].getAttribute("name");if("portable-cache"==f){a=d[e];break}}if(a)for(var g=a.getAttribute("content"),h=g.split(/\s*,\s*/g),i=0;i<h.length;i++){var j=h[i].split("=");2===j.length&&(c[j[0]]=j[1])}return c},getEntryByUrl:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].url===a)return this.entries[b];return void 0},clearAllCache:function(){for(var a=0;a<this.entries.length;a++)this.entries[a].removeCache()},getConfig:function(a){return void 0===a?c:c[a]}};var x=function(a,b){return b="function"!=typeof b?function(){}:b,h?(this.fs=null,h(TEMPORARY,1048576,function(b){__debug&&console.log("FileSystem initialized"),this.fs=b,this.ls=new A,"function"==typeof a&&a()}.bind(this),function(){b("failed initializing FileSystem.")}),void 0):(b("FileSystem not supported on this browser."),void 0)};x.prototype={set:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.createWriter(function(f){f.onwriteend=function(){__debug&&console.log("[%s] success creating data on FileSystem",a.url),a.src=e.toURL();var f={url:a.url,src:a.src,mimetype:a.mimetype,version:a.version};d.set(f,function(){b(a)},c,function(){c("quota error creating data on FileSystem")})},f.onerror=function(b){__debug&&console.error("[%s] error creating data on FileSystem: %s",a.url,b),c("error creating data on FileSystem: "+b)},"string"==typeof a.content?f.write(q(a.content,a.mimetype)):f.write(a.content)})},function(a){c("error creating data on FileSystem: "+a)})},function(a){c("error getting directory on FileSystem: "+a)})},get:function(a,b,c){this.ls?this.ls.get(a,function(d){if(null===d)b(d);else if(null===a.elem){var e=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!1,exclusive:!1},function(e){e.file(function(c){__debug&&console.log("[%s] success getting data on FileSystem",a.url),d.content=c,b(d)},function(b){__debug&&console.error("[%s] error getting data on FileSystem: %s",a.url,b),c("error getting data on FileSystem: "+b.message)})},function(b){__debug&&console.error("[%s] error getting data on FileSystem: %s",a.url,b),c("error getting data on FileSystem"+b)})},function(a){c("error getting directory on FileSystem: "+a.message)})}else b(d)}.bind(this),c):(__debug&&console.info("[%s] LocalStorage not ready",a.url),c("LocalStorage not ready."))},remove:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=a.url.replace(/\/|\./g,"_");this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.remove(function(){d.remove(a,b,c)},function(a){c("error removing data on FileSystem: "+a)})},function(a){c("error removing data on FileSystem: "+a)})},function(a){c("error getting directory on FileSystem: "+a)})},convertURL:function(a){return a.replace(/\/|\\/g,"_")}};var y=function(a,b){if(b="function"!=typeof b?function(){}:b,!i)return b("IndexedDB not supported on this browser."),void 0;this.db=null,this.version=1;var c=i.open(f,this.version);c.onsuccess=function(b){__debug&&console.log("IndexedDB initialized"),this.db=b.target.result,"function"==typeof a&&a()}.bind(this),c.onblocked=function(a){b("opening IndexedDB blocked: "+a.target.error.message)},c.onerror=function(a){b("error on opening IndexedDB: "+a.target.error.message)},c.onupgradeneeded=function(a){this.db=a.target.result,this.db.objectStoreNames.contains("cache")&&this.db.deleteObjectStore("cache");var b=this.db.createObjectStore("cache",{keyPath:"url"});__debug&&console.log("upgraded Indexed database",b)}.bind(this)};y.prototype={set:function(a,b,c,d){var e={url:a.url,content:a.content,mimetype:a.mimetype,version:a.version},f=this.db.transaction(["cache"],"readwrite");f.objectStore("cache").put(e),f.oncomplete=function(){__debug&&console.log("[%s] success inserting data into IndexedDB",a.url),"function"==typeof b&&b(a)},f.onerror=function(b){var e=b.target.error;__debug&&console.error("[%s] error inserting data into IndexedDB: %s",a.url,e.name),"QuotaExceededError"==e.name?d():"function"==typeof c&&c("error inserting data into IndexedDB: "+e.name)},f.onabort=function(b){var e=b.target.error;__debug&&console.error("[%s] error inserting data into IndexedDB: %s",a.url,e.name),"QuotaExceededError"==e.name?d():"function"==typeof c&&c("error inserting data into IndexedDB: "+e.name)}},get:function(a,b,c){b="function"!=typeof b?function(){}:b;var d=this.db.transaction(["cache"],"readonly").objectStore("cache").get(a.url);d.onsuccess=function(c){if(c.target.result){__debug&&console.log("[%s] success getting data from IndexedDB",a.url);var d=c.target.result;b(d)}else b(null)},d.onerror=function(){__debug&&console.error("[%s] error getting data from IndexedDB: %s",a.url,d.error.name),"function"==typeof c&&c("error getting data from IndexedDB: "+d.error.name)}},remove:function(a,b,c){var d=this.db.transaction(["cache"],"readwrite").objectStore("cache"),e=d["delete"](a.url);e.onsuccess=function(){__debug&&console.log("[%s] success removing data from IndexedDB",a.url),"function"==typeof b&&b()},e.onerror=function(){__debug&&console.error("[%s] error removing data from IndexedDB: %s",a.url,e.error.name),"function"==typeof c&&c("error removing data from IndexedDB: "+e.error.name)}}};var z=function(a,b){return a="function"!=typeof a?function(){}:a,j?(this.version="1.0",this.db=j(f,"","cache",1048576),this.db.version!==this.version?this.db.changeVersion(this.db.version,this.version,function(b){b.executeSql("CREATE TABLE cache (url TEXT PRIMARY KEY, content TEXT, mimetype TEXT, version TEXT)"),a()},function(){"function"==typeof b&&b("Failed changing WebSQL version.")},function(){__debug&&console.log("WebSQL Database upgraded.")}):(__debug&&console.log("WebSQL Database initialized."),setTimeout(function(){a()},0)),void 0):(setTimeout(function(){b("WebSQL not supported on this browser.")},0),void 0)};z.prototype={set:function(a,b,c,d){this.db.transaction(function(b){b.executeSql("INSERT INTO cache (url, content, mimetype, version) VALUES(?, ?, ?, ?)",[a.url,a.content,a.mimetype,a.version],function(){},function(a,b){var d=b.message;b.code===b.CONSTRAINT_ERR&&(d="URL already exists in cache. Check version string."),"function"==typeof c&&c("error inserting data into WebSQL: "+d)})},function(b){__debug&&console.error("[%s] error inserting data into WebSQL: %s",a.url,b.message),b.code===b.QUOTA_ERR?d():c("error inserting data into WebSQL: "+b.message)},function(){__debug&&console.log("[%s] success inserting data into WebSQL",a.url),"function"==typeof b&&b(a)})},update:function(a,b,c,d){this.db.transaction(function(b){b.executeSql("UPDATE cache SET mimetype=?, content=?, version=? WHERE url=?",[a.mimetype,a.content,a.version,a.url],function(){},function(a,b){"function"==typeof c&&c("error updating data on WebSQL: "+b.message)})},function(b){__debug&&console.error("[%s] error updating data on WebSQL: %s",a.url,b.message),b.code===b.QUOTA_ERR?d():c("error updating data on WebSQL: "+b.message)},function(){__debug&&console.log("[%s] success updating data on WebSQL",a.url),"function"==typeof b&&b(a)})},get:function(a,b,c){b="function"!=typeof b?function(){}:b,c="function"!=typeof c?function(){}:c,this.db.readTransaction(function(d){d.executeSql("SELECT * FROM cache WHERE url=?",[a.url],function(d,e){if(e.rows.length>0){var f=e.rows.item(0),g={url:a.url,content:f.content,mimetype:f.mimetype,version:f.version};b(g)}else 0===e.rows.length?b(null):c("error getting data from WebSQL.")},function(a,b){c("error getting data from WebSQL: "+b.message)})},function(b){__debug&&console.error("[%s] error getting data from WebSQL: %s",a.url,b.message),c("error getting WebSQL:"+b.message)},function(){__debug&&console.log("[%s] success getting data from WebSQL.",a.url)})},remove:function(a,b,c){this.db.transaction(function(b){b.executeSql("DELETE FROM cache WHERE url=?",[a.url],function(){},function(a,b){"function"==typeof c&&c("error removing WebSQL cache: "+b.message)})},function(b){__debug&&console.error("[%s] error removing data from WebSQL: %s",a.url,b.message),c("error removing WebSQL:"+b.message)},function(){__debug&&console.log("[%s] success removing data from WebSQL.",a.url),"function"==typeof b&&b()})}};var A=function(a,b){return k?(setTimeout(function(){"function"==typeof a&&a()},0),void 0):("function"==typeof b&&b("LocalStorage not supported on this browser."),void 0)};A.prototype={set:function(a,b,c){var d={src:a.src||"",content:a.content||"",mimetype:a.mimetype,version:a.version};setTimeout(function(){try{k.setItem(a.url,JSON.stringify(d)),__debug&&console.log("[%s] success inserting data into LocalStorage",a.url),"function"==typeof b&&b(a)}catch(e){__debug&&console.error("[%s] error inserting data into LocalStorage",a.url),"function"==typeof c&&c(e.message)}},0)},get:function(a,b,c){setTimeout(function(){try{var d=k.getItem(a.url)||null;d&&(d=JSON.parse(d)),__debug&&console.log("[%s] success getting data from LocalStorage",a.url),"function"==typeof b&&b(d)}catch(e){__debug&&console.error("[%s] error getting data from LocalStorage",a.url),"function"==typeof c&&c(e.message)}},0)},remove:function(a,b,c){setTimeout(function(){try{k.removeItem(a.url),__debug&&console.log("[%s] success removing data from LocalStorage",a.url),"function"==typeof b&&b()}catch(d){__debug&&console.error("[%s] error removing data from LocalStorage",a.url),"function"==typeof c&&c(d.message)}},0)}},a.CacheEntry=v,a.CacheManager=new w}(window,document),function(a,b){var c={version:"","auto-init":"yes","root-path":"/","preferred-storage":"auto","debug-mode":"no"},d=null,e="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f="PortableCache",g="NOT_SUPPORTED",h=a.requestFileSystem||a.webkitRequestFileSystem||a.mozRequestFileSystem||a.msRequestFileSystem||void 0,i=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB||void 0,j=a.openDatabase||void 0,k=a.localStorage||void 0,l=a.Blob||a.WebKitBlob||a.MozBlob||a.MsBlob||void 0,m=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MsBlobBuilder||void 0,n=(a.URL||a.webkitURL||a.mozURL||a.msURL||a.oURL||void 0,a.document.addEventListener?function(a,b,c){a.addEventListener(b,c)}:function(a,b,c){a.attachEvent("on"+b,c)}),o=a.document.removeEventListener?function(a,b,c){a.removeEventListener(b,c)}:function(a,b,c){a.detachEvent("on"+b,c)};Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var p=function(a){for(var b,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="",e=-6,f=0,g=0,h=0;g<a.length||e>-6;)0>e&&(g<a.length?(b=a[g++],h+=8):b=0,f=(255&f)<<8|255&b,e+=8),d+=c.charAt(h>0?f>>e&63:64),e-=6,h-=6;return d},q=function(a,b){var c=null;if(a instanceof l)return a;if(l)try{c=new l([a],{type:b})}catch(d){var e=new m;e.append(a),c=e.getBlob(b)}else if(m){var e=new m;e.append(a),c=e.getBlob(b)}return c},r=function(a){if(0===a.indexOf("http"))return a;if(0===a.indexOf("//"))return location.protocol+a;var b=function(a){return""===a?!1:!0},c=location.pathname.split("/").filter(b),d=a.split("/");do switch(d[0]){case"..":c=c.slice(0,-1),d=d.slice(1);break;case".":case"":d=d.slice(1)}while(".."==d[0]);return d=c.concat(d),location.origin+"/"+d.join("/")},s=function(b,c,d,e){if(null===c)return b;d=d||a.devicePixelRatio,e=e||a.innerWidth;var f,g=c.split(/\s*,\s*/g),h=[],i=0;for(h.push({url:b,w:1/0,x:1}),i=0;i<g.length;i++){var j=g[i].split(/\s+/g);if(!(j.length<2)){for(var k,l=j.shift(),m={url:l,x:1,w:1/0};k=j.shift(),void 0!==k;){var n=k.match(/^([0-9\.]+)(w|x)$/);n&&3===n.length&&(m[n[2]]=1*n[1])}h.push(m)}}var o=1/0,p=0;for(i=0;i<h.length;i++)f=h[i],e<=f.w&&f.w<=o&&(o=f.w);for(i=0;i<h.length;i++)f=h[i],f.w===o&&(0===p?p=f.x:d<=f.x&&(d>p||f.x<p)&&(p=f.x));for(i=0;i<h.length;i++)if(f=h[i],f.x==p&&f.w==o)return f.url;return b},t=function(c){for(var d=a.pageYOffset||b.documentElement.scrollTop,e=a.innerHeight||b.documentElement.clientHeight,f=d-e/4,g=d+~~(1.25*e),h=0;h<c.length;h++){var i=c[h],j=i.elem.offsetTop,k=i.elem.offsetHeight;
(f>=j+k||g>=j)&&(i.load(function(a){a.constructDOM()}),c.splice(h--,1))}},u={getItem:function(a){return a&&this.hasItem(a)?unescape(b.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},setItem:function(a,c,d,e,f,g){if(a&&!/^(?:expires|max\-age|path|domain|secure)$/i.test(a)){var h="";if(d)switch(d.constructor){case Number:h=1/0===d?"; expires=Tue, 19 Jan 2038 03:14:07 GMT":"; max-age="+d;break;case String:h="; expires="+d;break;case Date:h="; expires="+d.toGMTString()}b.cookie=escape(a)+"="+escape(c)+h+(f?"; domain="+f:"")+(e?"; path="+e:"")+(g?"; secure":"")}},removeItem:function(a,c){a&&this.hasItem(a)&&(b.cookie=escape(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; path="+c:""))},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(b.cookie)},keys:function(){for(var a=b.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),c=0;c<a.length;c++)a[c]=unescape(a[c]);return a}},v=function(a){if(this.src="",this.content="",this.mimetype="",this.lazyload=!1,this.root=b,a.nodeName){this.tag=a.nodeName.toLowerCase(),this.elem=a,this.root=this.elem.ownerDocument;var d=a.getAttribute("data-cache-url"),f=a.getAttribute("data-cache-srcset");this.url=c.version!=g?r(s(d,f)):s(d,f);var h=a.getAttribute("data-cache-version");this.version=null!==h?h:c.version,this.async=null===a.getAttribute("async")?!1:!0,this.type=/^(img|audio|video)/.test(this.tag)?"binary":"text"}else this.tag=a.tag||"",this.elem=null,this.url=r(a.url),this.version="string"==typeof a.version?a.version:c.version,this.type=a.type||"text";"img"==this.tag&&c.version!=g&&(this.elem.src=e,this.lazyload=null!==a.getAttribute("lazyload")?!0:!1)};v.prototype={load:function(a){a="function"!=typeof a?function(){}:a;var b=this,d=function(c){__debug&&console.error("[%s] %s.",b.url,c),a(b)};""===b.version||c.version==g?(__debug&&console.log("[%s] fallback without checking cache.",b.url),a(b)):null===c["prev-version"]?(__debug&&console.log("[%s] no version found. fetching.",b.url),b.fetch(function(c){b.content=c.content,b.mimetype=c.mimetype,b.createCache(!1,a,d)},d)):b.readCache(function(c){c?c.version!==b.version?(__debug&&console.log("[%s] deprecated cache found. fetching...",b.url),b.fetch(function(c){b.content=c.content,b.mimetype=c.mimetype,b.createCache(!0,a,d)},d)):(b.src=c.src||"",b.content=c.content||"",b.mimetype=c.mimetype,__debug&&console.log("[%s] cache found. loading.",b.url),a(b)):(__debug&&console.log("[%s] cache not found. fetching...",b.url),b.fetch(function(c){b.content=c.content,b.mimetype=c.mimetype,b.createCache(!1,a,d)},d))},d)},readCache:function(a,b){d?d.get(this,a,function(b){__debug&&console.error("[%s] %s",this.url,b),a(null)}):(__debug&&console.error("[%s] storage not ready",this.url),"function"==typeof b&&b(null))},createCache:function(a,b,c){var e=a&&d instanceof z?"update":"set";if(!d)return"function"==typeof c&&c("storage not ready"),void 0;-1!==this.url.indexOf(".css")&&(this.content=this.content.replace(/url\('?"?(.*?)"?'?\)/g,function(a,b){return"url('"+r(b)+"')"}));var f=this;d instanceof x?(__debug&&console.log("[%s] creating Blob cache in FileSystem.",f.url),d.set(f,b,c)):this.getContentAs("text",function(a){f.content=a,__debug&&console.log("[%s] creating DataURL cache.",f.url),d[e](f,b,c,function(){d instanceof z?(__debug&&console.log("[%s] quota error. second try.",f.url),d[e](f,b,c,function(){c("second quota error. giving up.")})):c("quota error. giving up.")})})},removeCache:function(a,b){d?d.remove(this):"function"==typeof b&&b("storage not ready.")},fetch:function(b,c){var d=new XMLHttpRequest,e="string"==typeof d.responseType;d.open("GET",this.url,!0),"binary"==this.type?e?(d.responseType="blob",d.responseType="blob"!==d.responseType?"arraybuffer":"blob"):d.overrideMimeType?d.overrideMimeType("text/plain; charset=x-user-defined"):c("binary not supported on this browser."):"json"==this.type&&(d.responseType="json",d.responseType="json"!=d.responseType?"text":"json"),d.onreadystatechange=function(){if(4===d.readyState){var f={};if(200===d.status||304===d.status){if(f.mimetype=d.getResponseHeader("Content-Type").replace(/^(.*?);.*$/g,"$1"),"binary"==this.type)if(e)"blob"==d.responseType?(f.content=d.response,__debug&&console.log("[%s] fetched binary as Blob.",this.url)):"arraybuffer"==d.responseType&&(f.content=q(d.response,f.mimetype),__debug&&console.log("[%s] fetched binary as ArrayBuffer.",this.url));else if("undefined"!=typeof VBArray)f.content=new VBArray(d.responseBody).toArray(),__debug&&console.log("[%s] fetched binary using VBArray.",this.url);else{for(var g=[],h=d.responseText,i=0;i<h.length;i++){var j=h.charCodeAt(i);g.push(255&j)}f.content="data:"+f.mimetype+";base64,"+p(g),__debug&&console.log("[%s] fetched binary using text manipulation.",this.url)}else if("json"==this.type)if(e)f.content=d.response;else try{f.content=JSON.parse(d.responseText)}catch(k){c("Unparsable JSON response")}else f.content=d.responseText,__debug&&console.log("[%s] fetched text content.",this.url);b(f)}else 0===d.status?-1===this.url.indexOf(a.location.origin)?c("XMLHttpRequest was not allowed because of Access-Control-Allow-Origin."):c("XMLHttpRequest unknown error."):c("XMLHttpRequest error: "+d.status)}}.bind(this),d.send()},constructDOM:function(a){switch(a="function"!=typeof a?function(){}:a,this.src||"string"!=typeof this.content||0!==this.content.indexOf("data:")||(this.src=this.content),this.mimetype){case"audio/wav":case"audio/x-wav":case"audio/aiff":case"audio/x-aiff":case"audio/mpeg":case"video/mpeg":case"video/h264":case"video/3gpp":case"video/ogg":case"video/quicktime":case"image/png":case"image/jpeg":case"image/gif":case"image/svg+xml":case"image/tiff":case"image/bmp":case"application/x-font-woff":case"font/x-font-woff":case"font/font-woff":case"font/woff":case"font/ttf":case"font/eot":case"font/otf":this.src?(this.elem.setAttribute("src",this.src),__debug&&console.log("[%s] replaced src of <%s>",this.url,this.tag),a()):(this.elem.setAttribute("src",this.url),__debug&&console.log("[%s] fallback to <%s>",this.url,this.tag),n(this.elem,"load",a));break;case"text/javascript":case"application/javascript":case"application/x-javascript":case"application/json":if(this.src)this.elem.async=this.async,this.elem.setAttribute("src",this.src),__debug&&console.log("[%s] replaced src of <script>",this.url),n(this.elem,"load",a);else{if(this.content)return this.tag="script",this.elem=b.createElement("script"),this.elem.async=this.async,this.elem.textContent=this.content,this.root.head.appendChild(this.elem),__debug&&console.log("[%s] inlined to <script>",this.url),a(),void 0;this.elem.async=this.async,this.elem.setAttribute("src",this.url),__debug&&console.log("[%s] fallback to <script>",this.url),n(this.elem,"load",a)}break;case"text/css":this.src?(this.elem.setAttribute("href",this.src),__debug&&console.log("[%s] replaced href of <link>",this.url),a()):this.content&&"stylesheet"==this.elem.rel?(this.tag="style",this.elem=b.createElement("style"),this.elem.textContent=this.content,this.root.head.appendChild(this.elem),__debug&&console.log("[%s] inserted <style>",this.url),a()):(this.elem.setAttribute("href",this.url),__debug&&console.log("[%s] fallback to <link>",this.url),n(this.elem,"load",a));break;case"text/plain":case"text/html":case"text/xhtml+xml":case"application/xml":break;default:var c="script"==this.tag?"src":"link"==this.tag?"href":"img"==this.tag?"src":"audio"==this.tag?"src":"video"==this.tag?"src":void 0;c&&(this.elem.setAttribute(c,this.url),__debug&&console.log("[%s] fallback to <%s>",this.url,this.tag),n(this.elem,"load",a))}},getContentAs:function(a,b){var c=l?new FileReader:null;switch(""===this.content&&(__debug&&console.error("[%s] content not loaded.",this.url),b(null)),a){case"text":c&&this.content instanceof l?(__debug&&console.log("[%s] converting Blob to DataURL using FileReader.",this.url),c.onload=function(a){b(a.target.result)}.bind(this),c.readAsDataURL(this.content)):this.content instanceof Array?(__debug&&console.log("[%s] converting Blob to DataURL with manipulation.",this.url),b("data:"+this.mimetype+";base64,"+p(this.content))):"string"==typeof this.content&&b(this.content);break;case"arraybuffer":if(c&&this.content instanceof l)__debug&&console.log("[%s] converting Blob to ArrayBuffer using FileReader.",this.url),c.onload=function(a){b(a.target.result)}.bind(this),c.readAsArrayBuffer(this.content);else if(atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var d=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(d.buffer)}else __debug&&console.error("[%s] ArrayBuffer not supported on this browser.",this.url),b(null);break;case"blob":if(this.content instanceof l)b(this.content);else if(c&&ArrayBuffer&&atob&&"string"==typeof this.content&&0===this.content.indexOf("data:")){var d=new Uint8Array(atob(this.content.split(",")[1]).split("").map(function(a){return a.charCodeAt(0)}));b(q(d.buffer,this.mimetype))}else __debug&&console.error("[%s] Blob not supported on this browser.",this.url),b(null)}}};var w=function(){this.entries=[],this.lazyload=[],this.parseConfig();var e="no"!=c["auto-init"]?this.bootstrap.bind(this):function(){};if(c["prev-version"]==g||void 0===b.querySelectorAll||void 0===b.textContent||void 0===b.head)__debug&&console.log("This browser is not supported."),c.version=g,n(a,"load",e);else{var f=function(f){__debug&&console.log("%s Falling back.",f),d=null,"no"!=c["auto-init"]&&("complete"==b.readyState||"interactive"==b.readyState||"loaded"==b.readyState?this.bootstrap():n(a,"load",e))},l=c["preferred-storage"];d="filesystem"==l||h&&"auto"==l?new x(e,f.bind(this)):"idb"==l||i&&"auto"==l?new y(e,f.bind(this)):"sql"==l||j&&"auto"==l?new z(e,f.bind(this)):"localstorage"==l||k&&"auto"==l?new A(e,f.bind(this)):void 0,d||(__debug&&console.log("None of storages are available. Falling back."),n(a,"load",e))}};w.prototype={bootstrap:function(){var d=function(){this.lazyload.length?t(this.lazyload):(o(b,"scroll",d),__debug&&console.log("lazyload done. removed `scroll` event"))}.bind(this);b.body.style.display="none",this.queryTags(b,["link","script"],function(){if(b.body.style.display="block",c.version!=g){var e;if(b.createEvent?(e=b.createEvent("HTMLEvents"),e.initEvent("pcache-ready",!0,!1)):e=new Event("pcache-ready",{bubbles:!0,cancelable:!1}),b.dispatchEvent(e),__debug&&a.performance){var f=a.performance.timing.loadEventStart-a.performance.timing.requestStart;__debug&&console.log("pcache-ready:",f/1e3,"sec"),console.timeStamp&&console.timeStamp("pcache-ready")}}this.queryTags(b,["img","audio","video"],function(){this.lazyload.length>0&&n(b,"scroll",d)}.bind(this))}.bind(this)),u.setItem("pcache_version",c.version,null,c["root-path"])},resolveTag:function(a,b,c){for(var d=a.getElementsByTagName(b),e=d.length,f=0,g=0,h=0,i=[],j=[],k=function(){g++,f===g&&"function"==typeof c&&c()},l=0;e>l;l++)if(null!==d[l].getAttribute("data-cache-url")){f++;var m=new v(d[l]);this.entries.push(m),m.lazyload?(f--,this.lazyload.push(m)):("script"!=m.tag||m.async||i.push(m),m.load(function(a){if("script"!=a.tag||a.async)a.constructDOM(k);else{var b=i.indexOf(a);if(j[b]=a,b===h)for(;j[h];)i[h++].constructDOM(k)}}))}0===f&&"function"==typeof c&&c()},queryTags:function(a,b,c){for(var d=0,e=b.length;b.length;)this.resolveTag(a,b.shift(),function(){++d==e&&"function"==typeof c&&c()})},parseConfig:function(){var d=null;if(b.querySelector)d=b.querySelector('meta[name="portable-cache"]');else for(var e=b.getElementsByTagName("meta"),f=0;f<e.length;f++){var g=e[f].getAttribute("name");if("portable-cache"==g){d=e[f];break}}if(d)for(var h=d.getAttribute("content"),i=h.split(/\s*,\s*/g),j=0;j<i.length;j++){var k=i[j].split("=");2===k.length&&(c[k[0]]=k[1])}c["prev-version"]=u.getItem("pcache_version"),__debug="undefined"==typeof __debug&&"no"!==c["debug-mode"]&&a.console?!0:!1,__debug&&console.log("configuration loaded:",c)},getEntryByUrl:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].url===a)return this.entries[b];return void 0},clearAllCache:function(){for(var a=0;a<this.entries.length;a++)this.entries[a].removeCache()},getConfig:function(a){return void 0===a?c:c[a]}};var x=function(a,b){return b="function"!=typeof b?function(){}:b,h?(this.fs=null,h(TEMPORARY,1048576,function(b){__debug&&console.log("FileSystem initialized"),this.fs=b,this.ls=new A,"function"==typeof a&&a()}.bind(this),function(){b("failed initializing FileSystem.")}),void 0):(b("FileSystem not supported on this browser."),void 0)};x.prototype={set:function(a,b,c,d){var e=this.ls;c="function"!=typeof c?function(){}:c;var g=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(g,{create:!0,exclusive:!1},function(f){f.createWriter(function(g){g.onwriteend=function(){__debug&&console.log("[%s] success creating data on FileSystem.",a.url),a.src=f.toURL();var g={url:a.url,src:a.src,mimetype:a.mimetype,version:a.version};e.set(g,function(){b(a)},c,function(){__debug&&console.error("quota error creating data on FileSystem."),d()})},g.onerror=function(b){__debug&&console.error("[%s] error creating data on FileSystem: %s",a.url,b),c("error creating data on FileSystem: "+b)},"string"==typeof a.content?g.write(q(a.content,a.mimetype)):g.write(a.content)})},function(a){c("error creating data on FileSystem: "+a)})},function(a){c("error getting directory on FileSystem: "+a)})},get:function(a,b,c){this.ls?this.ls.get(a,function(d){if(null===d)b(d);else if(null===a.elem){var e=this.convertURL(a.url);this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!1,exclusive:!1},function(e){e.file(function(c){__debug&&console.log("[%s] success getting data on FileSystem",a.url),d.content=c,b(d)},function(b){__debug&&console.error("[%s] error getting data on FileSystem: %s",a.url,b),c("error getting data on FileSystem: "+b.message)})},function(b){__debug&&console.error("[%s] error getting data on FileSystem: %s",a.url,b),c("error getting data on FileSystem"+b)})},function(a){c("error getting directory on FileSystem: "+a.message)})}else b(d)}.bind(this),c):(__debug&&console.info("[%s] LocalStorage not ready",a.url),c("LocalStorage not ready."))},remove:function(a,b,c){var d=this.ls;c="function"!=typeof c?function(){}:c;var e=a.url.replace(/\/|\./g,"_");this.fs.root.getDirectory(f,{create:!0,exclusive:!1},function(f){f.getFile(e,{create:!0,exclusive:!1},function(e){e.remove(function(){d.remove(a,b,c)},function(a){c("error removing data on FileSystem: "+a)})},function(a){c("error removing data on FileSystem: "+a)})},function(a){c("error getting directory on FileSystem: "+a)})},convertURL:function(a){return a.replace(/\/|\\/g,"_")}};var y=function(a,b){if(b="function"!=typeof b?function(){}:b,!i)return b("IndexedDB not supported on this browser."),void 0;this.db=null,this.version=1;var c=i.open(f,this.version);c.onsuccess=function(b){__debug&&console.log("IndexedDB initialized"),this.db=b.target.result,"function"==typeof a&&a()}.bind(this),c.onblocked=function(a){b("opening IndexedDB blocked: "+a.target.error.message)},c.onerror=function(a){b("error on opening IndexedDB: "+a.target.error.message)},c.onupgradeneeded=function(a){this.db=a.target.result,this.db.objectStoreNames.contains("cache")&&this.db.deleteObjectStore("cache");var b=this.db.createObjectStore("cache",{keyPath:"url"});__debug&&console.log("upgraded Indexed database",b)}.bind(this)};y.prototype={set:function(a,b,c,d){{var e={url:a.url,content:a.content,mimetype:a.mimetype,version:a.version},f=this.db.transaction(["cache"],"readwrite");f.objectStore("cache").put(e)}f.oncomplete=function(){__debug&&console.log("[%s] success inserting data into IndexedDB",a.url),"function"==typeof b&&b(a)},f.onerror=function(b){var d=b.target.error;__debug&&console.error("[%s] error inserting data into IndexedDB: %s",a.url,d.name),"function"==typeof c&&c("error inserting data into IndexedDB: "+d.name)},f.onabort=function(b){var e=b.target.error;__debug&&console.error("[%s] error inserting data into IndexedDB: %s",a.url,e.name),"QuotaExceededError"==e.name?d():"function"==typeof c&&c("error inserting data into IndexedDB: "+e.name)}},get:function(a,b,c){b="function"!=typeof b?function(){}:b;var d=this.db.transaction(["cache"],"readonly").objectStore("cache").get(a.url);d.onsuccess=function(c){if(c.target.result){__debug&&console.log("[%s] success getting data from IndexedDB",a.url);var d=c.target.result;b(d)}else b(null)},d.onerror=function(){__debug&&console.error("[%s] error getting data from IndexedDB: %s",a.url,d.error.name),"function"==typeof c&&c("error getting data from IndexedDB: "+d.error.name)}},remove:function(a,b,c){var d=this.db.transaction(["cache"],"readwrite").objectStore("cache"),e=d["delete"](a.url);e.onsuccess=function(){__debug&&console.log("[%s] success removing data from IndexedDB",a.url),"function"==typeof b&&b()},e.onerror=function(){__debug&&console.error("[%s] error removing data from IndexedDB: %s",a.url,e.error.name),"function"==typeof c&&c("error removing data from IndexedDB: "+e.error.name)}}};var z=function(a,b){return a="function"!=typeof a?function(){}:a,j?(this.version="1.0",this.db=j(f,"","cache",1048576),this.db.version!==this.version?this.db.changeVersion(this.db.version,this.version,function(b){b.executeSql("CREATE TABLE cache (url TEXT PRIMARY KEY, content TEXT, mimetype TEXT, version TEXT)"),a()},function(){"function"==typeof b&&b("Failed changing WebSQL version.")},function(){__debug&&console.log("WebSQL Database upgraded.")}):(__debug&&console.log("WebSQL Database initialized."),setTimeout(function(){a()},0)),void 0):(setTimeout(function(){b("WebSQL not supported on this browser.")},0),void 0)};z.prototype={set:function(a,b,c,d){this.db.transaction(function(b){b.executeSql("INSERT INTO cache (url, content, mimetype, version) VALUES(?, ?, ?, ?)",[a.url,a.content,a.mimetype,a.version],function(){},function(a,b){var d=b.message;b.code===b.CONSTRAINT_ERR&&(d="URL already exists in cache. Check version string."),"function"==typeof c&&c("error inserting data into WebSQL: "+d)})},function(b){__debug&&console.error("[%s] error inserting data into WebSQL: %s",a.url,b.message),b.code===b.QUOTA_ERR?d():c("error inserting data into WebSQL: "+b.message)},function(){__debug&&console.log("[%s] success inserting data into WebSQL",a.url),"function"==typeof b&&b(a)})},update:function(a,b,c,d){this.db.transaction(function(b){b.executeSql("UPDATE cache SET mimetype=?, content=?, version=? WHERE url=?",[a.mimetype,a.content,a.version,a.url],function(){},function(a,b){"function"==typeof c&&c("error updating data on WebSQL: "+b.message)})},function(b){__debug&&console.error("[%s] error updating data on WebSQL: %s",a.url,b.message),b.code===b.QUOTA_ERR?d():c("error updating data on WebSQL: "+b.message)},function(){__debug&&console.log("[%s] success updating data on WebSQL",a.url),"function"==typeof b&&b(a)})},get:function(a,b,c){b="function"!=typeof b?function(){}:b,c="function"!=typeof c?function(){}:c,this.db.readTransaction(function(d){d.executeSql("SELECT * FROM cache WHERE url=?",[a.url],function(d,e){if(e.rows.length>0){var f=e.rows.item(0),g={url:a.url,content:f.content,mimetype:f.mimetype,version:f.version};b(g)}else 0===e.rows.length?b(null):c("error getting data from WebSQL.")},function(a,b){c("error getting data from WebSQL: "+b.message)})},function(b){__debug&&console.error("[%s] error getting data from WebSQL: %s",a.url,b.message),c("error getting WebSQL:"+b.message)},function(){__debug&&console.log("[%s] success getting data from WebSQL.",a.url)})},remove:function(a,b,c){this.db.transaction(function(b){b.executeSql("DELETE FROM cache WHERE url=?",[a.url],function(){},function(a,b){"function"==typeof c&&c("error removing WebSQL cache: "+b.message)})},function(b){__debug&&console.error("[%s] error removing data from WebSQL: %s",a.url,b.message),c("error removing WebSQL:"+b.message)},function(){__debug&&console.log("[%s] success removing data from WebSQL.",a.url),"function"==typeof b&&b()})}};var A=function(a,b){return k?(setTimeout(function(){"function"==typeof a&&a()},0),void 0):("function"==typeof b&&b("LocalStorage not supported on this browser."),void 0)};A.prototype={set:function(a,b,c,d){var e={src:a.src||"",content:a.content||"",mimetype:a.mimetype,version:a.version};setTimeout(function(){try{k.setItem(a.url,JSON.stringify(e)),__debug&&console.log("[%s] success inserting data into LocalStorage",a.url),"function"==typeof b&&b(a)}catch(f){__debug&&console.error("[%s] %s",a.url,f.message),f.code===f.QUOTA_EXCEEDED_ERR&&d(),"function"==typeof c&&c(f.message)}},0)},get:function(a,b,c){setTimeout(function(){try{var d=k.getItem(a.url)||null;d&&(d=JSON.parse(d)),__debug&&console.log("[%s] success getting data from LocalStorage",a.url),"function"==typeof b&&b(d)}catch(e){__debug&&console.error("[%s] error getting data from LocalStorage",a.url),"function"==typeof c&&c(e.message)}},0)},remove:function(a,b,c){setTimeout(function(){try{k.removeItem(a.url),__debug&&console.log("[%s] success removing data from LocalStorage",a.url),"function"==typeof b&&b()}catch(d){__debug&&console.error("[%s] error removing data from LocalStorage",a.url),"function"==typeof c&&c(d.message)}},0)}},a.CacheEntry=v,a.PortableCache=new w}(window,document);